<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="styles.css"/>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    // api => c64935bbcd934978a0dce240247cf564
  </head>

  <body>
    <div class="flex-container">
      <!-- Create a div where the graph will take place -->
      <div id="my_dataviz"></div>
      <div id="side_panel"></div>
    </div>

    <script>
      // Define the div for the tooltip

      // set the dimensions and margins of the graph
      var margin = { top: 10, right: 30, bottom: 30, left: 60 },
        width = 1200 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;
      //GLOBAL VARiABLES
      var MAXDATAPOINTS = 20 ;
      var dotRadius = 3.2;
      var xScale;
      var yScale;

      // append the svg object to the body of the page
      var svg = d3
        .select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var tooltip = d3
        .select("#my_dataviz")
        .append("div")
        .attr("class", "tooltip");

      //Read the data

      d3.csv(
        "https://raw.githubusercontent.com/anorneto/data-vis-2019/master/data/ibovespa.csv"
      ).then(
        // Now I can use this dataset:
        function(data) {
          data.forEach(function(d) {
            d.date = d3.timeParse("%d.%m.%Y")(d.date);
            d.last = d.last
              .slice(0, -3)
              .split(".")
              .join("");
            d.variation = d.variation
              .slice(0, -1)
              .split(",")
              .join(".");
            d.opening = d.opening
              .slice(0, -3)
              .split(".")
              .join("");
          });

          // Add X axis Scale--> it is a date format
          var x = d3
            .scaleTime()
            .domain(
              d3.extent(data, function(d) {
                return d.date;
              })
            )
            .range([0, width]);
          xScale = x;

          svg
            .append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

          // Add Y axis Scale
          var y = d3
            .scaleLinear()
            .domain([
              d3.min(data, function(d) {
                return +d.last;
              }),
              d3.max(data, function(d) {
                return +d.last;
              })
            ])
            .range([height, 0]);
          yScale = y;

          svg.append("g").call(d3.axisLeft(y));

          // Add the line
          svg
            .append("path")
            .datum(data)
            .attr("id", "line")
            .attr(
              "d",
              d3
                .line()
                .x(function(d) {
                  return x(d.date);
                })
                .y(function(d) {
                  return y(d.last);
                })
            );

          // Create a data set of points
          var dataPoints = data
            .sort(function(a, b) {
              return Math.abs(b.variation) - Math.abs(a.variation);
            })
            .slice(0, MAXDATAPOINTS);
          console.log(dataPoints);
          // Mark the points on the graph
          svg
            .selectAll(".dot")
            .data(dataPoints)
            .enter()
            .append("circle")
            .attr("class", "dot")
            .attr("r", dotRadius)
            .attr("cx", function(d) {
              return x(d.date);
            })
            .attr("cy", function(d) {
              return y(d.last);
            })
            .on("mouseover", handleMouseOver)
            .on("mouseout", handleMouseOut);
        }
      );

      // Create Event Handlers for mouse
      function handleMouseOver(d, i) {
        tooltip
          .transition()
          .duration(450)
          .style("opacity", "1");
        tooltip
          .style("top", event.pageY - 85 + "px")
          .style("left", event.pageX - 60 + "px");
        tooltip.html(`<p>${d.date.toDateString()}<br>${d.last}</p>`);
        d3.select(this).attr("r", dotRadius * 2);
      }

      function handleMouseOut(d, i) {
        tooltip
          .transition()
          .duration(450)
          .style("opacity", "0");
        d3.select(this).attr("r", dotRadius);
      }
    </script>
  </body>
</html>
